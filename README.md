# Постановка задачи

С 15 по 26 число каждого месяца клиенты энергетической компании Приволжского Федерального округа (в городах, деревнях и селах) передают показания электроэнергии и, так как, клиентов более 1 миллиона то в пике количество запросов может достигать 1000 запросов в секунду

1. Требуется написать какие возможные проблемы могут возникнуть при работе сервиса, который будет принимать эти показания и сохранять в базу данных 
2. Указать возможные решения этих проблем 
3. Нарисовать примерную архитектуру сервиса исходя из пунктов выше с пояснениями

# Решение

1. Возможные причины проблем при работе сервиса
- Недоступность сервиса;
- Отказ в работе сервиса по причине высокой нагрузки API сервера;
- Отказ в работе сервиса по причине высокой нагрузки базы данных;
2. Возможные решения
Горизонтальное масштабирование и балансировка нагрузки, на мой взгляд, хорошее решение двух первых проблем, определенных в первом пункте. С помощью технологий контейнеризации можно увеличить или уменьшить количество экземпляров микросервиса, в зависимости от потребностей. А в случае сбоя в работе одного экземпляра микросервиса, нагрузка будет распределена между оставшимися и сервис продолжит работу.\
Немного сложнее увеличить производительность базы данных. В зависимости от ситуации можно реализовать репликацию master – slave, это позволит разгрузить базу данных от запросов на чтение, а как правило именно выборка данных требует больше вычислительных мощностей. Но это не даст результата если база данных достигла предела по запросам на запись/изменение данных. В этом случае возможно реализовать репликацию master – master. У нее есть свои недостатки, связанные с конфликтом данных и рассинхронизацией, но это может решить проблему скорости записи данных.
Для высоконагруженных систем большое значение имеет оптимизация выполнения и оптимальные настройки конфигурации.\
3. Архитектура сервиса
![Архитектура сервиса](https://github.com/MedvedevEA/energy/blob/main/serviceScheme.png?raw=true)
# Практика
В рамках технического задания был создан проект, который воспроизводит работу сервиса. Проект состоит из двух программ.\ 
Первая программа(server) имитирует работу сервиса. В процессе тестирования, на основании образа данной программы(energy:v1) были развернуты десять контейнеров. Пять копий программы, которые в качестве базы данных используют Postgres и пять копий, которые используют базу данных Cockroach. Соответственно, так же были развернуты сервера баз данных Postgres(postgres-db) и Chockroach(cockroach-db).
```
CONTAINERID	IMAGE	PORTS	NAMES
99f81252936b	energy:v1	0.0.0.0:8000->8000/tcp	server-8000-postgres
1ef5f09993d3	energy:v1	0.0.0.0:8004->8000/tcp	server-8004-postgres
97a0352123b9	energy:v1	0.0.0.0:8014->8000/tcp	server-8014-cockroach
56b1b3fb51c8	energy:v1	0.0.0.0:8001->8000/tcp	server-8001-postgres
1e945f513eef	energy:v1	0.0.0.0:8012->8000/tcp	server-8012-cockroach
49a57706043b	energy:v1	0.0.0.0:8002->8000/tcp	server-8002-postgres
e73fc9089d4d	energy:v1	0.0.0.0:8003->8000/tcp	server-8003-postgres
176eb2d35efe	energy:v1	0.0.0.0:8010->8000/tcp	server-8010-cockroach
5bb2cbda7f05	energy:v1	0.0.0.0:8011->8000/tcp	server-8011-cockroach
9836c9ba04a4	energy:v1	0.0.0.0:8013->8000/tcp	server-8013-cockroach
a32ee75487c0	postgres:latest	5432/tcp	postgres-db
0946b78ec3d4	cockroachdb/cockroach:latest	8080/tcp , 26257/tcp	cockroach-db
```
Вторая программа(test) отправляет тестовые запросы и собирает статистику их выполнения. Настойка параметров тестирования выполняется с помощью задания значений констант программы. Статистика формируется на основании ответов сервера. Ответы сервера интерпретировались следующим образом: код ответа 201 – запрос выполнен успешно, код ответа 500 – нет ответа от базы данных, запрос вернул ошибку(error) – нет ответа от API сервера.\ 
Это работает! Но не требуйте от данного проекта слишком много.
## Подготовка к проведению тестов
1. Клонируйте репозиторий.
2. Создайте образ сервера:
```
docker build --tag energy:v1 ./server/
``` 
3. Разверните сервисы:
```
docker compose up -d
```
4. Запустите тест:
```
cd test
go run main.go
```
Меняйте значение констант в коде программы, повторяйте процесс тестирования.  
## Результаты тестирования:
### Тест №1
Параметры теста
```
Продолжительность(сек.): 	5
Запросов в секунду: 	200
Количество копий серверов: 	1
База данных: 	postgres
Порядок отправки запросов к базе данных: 	параллельный
```
Результат:
```
…
201 Created : 947
500 Internal Server Error : 53
```
Вывод:\
Слабое место база данных. Необходимо изменить формат запросов (объединять несколько запросов от сервера в один запрос для базы данных или делать их последовательно) или внести изменения в конфигурацию базы данных или рассмотреть возможность использования другой базы данных.
### Тест №2
Параметры теста
```
Продолжительность(сек.): 	5
Запросов в секунду: 	300
Количество копий серверов: 	1
База данных: 	postgres
Порядок отправки запросов к базе данных: 	последовательный
```
Результат:
```
…
error : 248
201 Created : 1252
```
Вывод:\
Последовательное выполнение запросов к базе данных решило проблему.\ 
Один API сервер может корректно обработать около 200 запросов в секунду. Увеличение количества запросов до 300 привело к ошибкам API сервера. Проблема решается с помощью горизонтального масштабирования. Для планового показателя в 1000 запросов в секунду необходимо около пяти копий API сервера.
### Тест №3
Параметры теста
```
Продолжительность(сек.): 	5
Запросов в секунду: 	1000
Количество копий серверов: 	5
База данных: 	postgres
Порядок отправки запросов к базе данных: 	последовательный
```
Результат:
```
…
01:14:06.501 Second 1
01:14:07.513 Second 2
01:14:08.514 Second 3
01:14:09.515 Second 4
01:14:10.517 Second 5
01:14:11.517 Wait goroutines
01:14:15.315 End test
…
201 Created 5000
```
Вывод:\
Тест прошёл успешно, но из лога выполнения программы, приведенного в результатах, видно, что ожидание завершения запросов (Отметка времени End test минус отметка времени Wait goroutines) составляет около 4 секунд, что скорее всего является следствием последовательного обращения к базе данных. 
### Тест №4
Параметры теста
```
Продолжительность(сек.): 	5
Запросов в секунду: 	1000
Количество копий серверов: 	5
База данных: 	cockroach
Порядок отправки запросов к базе данных: 	параллельный
```
Результат:
```
…
01:31:41.09 Second 1
01:31:42.091 Second 2
01:31:43.091 Second 3
01:31:44.092 Second 4
01:31:45.096 Second 5
01:31:46.098 Wait goroutines
01:31:46.191 End test
…
201 Created 5000
```
Вывод:\
Cockroach – это современная, облачная, распределенная база данных, которая в значительной степени совместима с Postgres. Глубокий анализ не проводился, но эта база данных отлично справляется с обработкой множества параллельных обращений имея параметры конфигурации по умолчанию. 

